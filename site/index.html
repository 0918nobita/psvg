
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.1/codemirror.min.css">
<link rel="stylesheet" href="https://codemirror.net/theme/xq-light.css">
<style>
/* modify xq-light theme so strings don't look crazy red */
.cm-s-xq-light span.cm-string { color: rgb(200,50,10); }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.1/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.1/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.1/addon/comment/comment.min.js"></script>
<script src="https://codemirror.net/mode/xml/xml.js"></script>
<style>
  body{
    margin:4px;
    margin-left:10px;
    overflow:hidden;
  }
  h1{
    margin:0px;
    font-size:20px;
    font-weight: lighter;
    letter-spacing:10px;
    font-family: sans-serif;
  }
</style>
<style>.CodeMirror { height: 100%; }</style>
<body>
  <h1>PSVG</h1>
  <i style="font-size:13px;font-weight:lighter;">Programmable SVG format</i>
  <div id="c" style="position:absolute;left:0px;top:50px;width:50%;height:calc(100% - 50px);"></div>
  <div id="o" style="position:absolute;left:50%;top:50px;width:50%;height:calc(100% - 50px);"></div>
  <select id="s" style="position:absolute;right:calc(50% + 10px);top:55px;z-index:999;">
    <option value="helloworld.psvg">helloworld.psvg</option><option value="hilbert.psvg">hilbert.psvg</option><option value="koch.psvg">koch.psvg</option><option value="poisson.psvg">poisson.psvg</option><option value="pythagoras.psvg">pythagoras.psvg</option><option value="sierpinski.psvg">sierpinski.psvg</option><option value="textanim.psvg">textanim.psvg</option><option value="tree.psvg">tree.psvg</option>
  </select>
  
  <button id="r" style="position:absolute;left:calc(50% - 100px);top:4px;height:40px;width:200px;">COMPILE</button>
  <hr style="position: absolute;left:0px;top:40px;width:100%"/>
</body>
<script>
  function parsePSVG(str) {
    str = str.replace(/<!--[^\0]*?-->/gm, "");
    var i = 0;
    var elts = [];
    var _loop_1 = function () {
        if (str[i] == "<") {
            var j_1 = i + 1;
            var j0_1 = -1;
            var j1_1 = -1;
            var quote = false;
            var lvl = 0;
            function parseElement() {
                function getTagName(open) {
                    return open.trim().split(" ")[0];
                }
                function getAttributes(open) {
                    // oneliner doesn't work for safari:
                    // return Object['fromEntries'](Array['from'](open.split(" ").slice(1).join(" ")['matchAll'](/(^| )([^ ]+?)\="([^"]*)"/g)).map((x:string)=>x.slice(2)));
                    // stupid polyfill for safari:
                    var thing1 = open.split(" ").slice(1).join(" ");
                    var thing2 = thing1['matchAll'];
                    if (!thing2) {
                        thing2 = function (re) { var ms = []; var m; while (1) {
                            m = re.exec(thing1);
                            if (m)
                                ms.push(m);
                            else
                                break;
                        } return ms; };
                    }
                    else {
                        thing2 = function (re) { return thing1.matchAll(re); };
                    }
                    if (!Object['fromEntries']) {
                        Object['fromEntries'] = function (a) { var o = {}; a.map(function (x) { return o[x[0]] = x[1]; }); return o; };
                    }
                    return Object['fromEntries'](Array['from'](thing2(/(^| )([^ ]+?)\="([^"]*)"/g)).map(function (x) { return x.slice(2); }));
                }
                if (j0_1 != -1) {
                    var open_1 = str.slice(i + 1, j0_1 - 1);
                    var body = str.slice(j0_1, j1_1);
                    // let close = str.slice(j1,j+1);
                    var elt = {
                        tagName: getTagName(open_1),
                        attributes: getAttributes(open_1),
                        children: parsePSVG(body),
                        innerHTML: body
                    };
                    elts.push(elt);
                }
                else {
                    var open_2 = str.slice(i + 1, j_1);
                    var elt = {
                        tagName: getTagName(open_2),
                        attributes: getAttributes(open_2),
                        children: [],
                        innerHTML: ""
                    };
                    elts.push(elt);
                }
            }
            while (j_1 <= str.length) {
                if (str[j_1] == '\\') {
                    j_1++;
                }
                if (str[j_1] == '"') {
                    quote = !quote;
                }
                if (!quote) {
                    if (str[j_1] == ">" && lvl == 0 && j0_1 == -1) {
                        j0_1 = j_1 + 1;
                    }
                    if (str[j_1] == "<") {
                        if (str[j_1 + 1] == "/") {
                            lvl--;
                            if (lvl == -1) {
                                j1_1 = j_1;
                            }
                            while (str[j_1] != ">") {
                                j_1++;
                            }
                            if (lvl == -1) {
                                parseElement();
                                i = j_1;
                                break;
                            }
                        }
                        else {
                            lvl++;
                        }
                    }
                    else if (str[j_1] == "/" && str[j_1 + 1] == ">") {
                        lvl--;
                        if (lvl == -1) {
                            parseElement();
                            i = j_1;
                            break;
                        }
                    }
                }
                j_1++;
            }
        }
        i++;
    };
    while (i <= str.length) {
        _loop_1();
    }
    return elts;
}
function transpilePSVG(prgm) {
    var funcs = {};
    function __val(x) {
        if (new RegExp(/^[+-]?(\d+([.]\d*)?([eE][+-]?\d+)?|[.]\d+([eE][+-]?\d+)?)$/g).test(x)) {
            return parseFloat(x);
        }
        if (x == "true" || x == "false") {
            return x == "true";
        }
        var hascm = x['includes'](',');
        if (hascm) {
            x = x.replace(/, */g, ',');
            var hasws = x['includes'](' ');
            var y = __tolist(x);
            if (!hasws) {
                y['allCommas'] = true;
            }
            return y;
        }
        if (x['includes'](' ')) {
            return __tolist(x);
        }
        return x;
    }
    function __makelist(x) {
        x.toString = function () { return x.join(x['allCommas'] ? ',' : ' '); };
        return x;
    }
    function __tolist(s) {
        return __makelist(s.replace(/,/g, ' ').split(" ").filter(function (x) { return x.length; }).map(__val));
    }
    var builtins = {
        NTH: (function (x, i) {
            if (typeof x == 'string') {
                x = __tolist(x);
            }
            return x[i];
        }).toString(),
        TAKE: (function (x, n) {
            if (typeof x == 'string') {
                x = __tolist(x);
            }
            return __makelist(x.slice(0, n));
        }).toString(),
        DROP: (function (x, n) {
            if (typeof x == 'string') {
                x = __tolist(x);
            }
            return __makelist(x.slice(n));
        }).toString(),
        UPDATE: (function (x, i, y) {
            if (typeof x == 'string') {
                x = __tolist(x);
            }
            var z = x.slice();
            z[i] = y;
            return __makelist(z);
        }).toString(),
        MAP: (function (x, f) {
            if (typeof x == 'string') {
                x = __tolist(x);
            }
            return __makelist(x.map(function (y) { return f(__val(y)); }));
        }).toString(),
        FILTER: (function (x, f) {
            if (typeof x == 'string') {
                x = __tolist(x);
            }
            return __makelist(x.filter(function (y) { return f(__val(y)); }));
        }).toString(),
        COUNT: (function (x) {
            if (typeof x == 'string') {
                x = __tolist(x);
            }
            return x.length;
        }).toString(),
        CAT: (function () {
            var args = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                args[_i] = arguments[_i];
            }
            return __makelist([].concat.apply([], args.filter(function (y) { return y.toString().length; }).map(function (x) { return (typeof x == 'string') ? __tolist(x) : x; })));
        }).toString(),
        REV: (function (x) {
            if (typeof x == 'string') {
                x = __tolist(x);
            }
            return __makelist(x.slice().reverse());
        }).toString(),
        FILL: (function (x, n) {
            return __makelist(new Array(n)['fill'](x));
        }).toString(),
        LERP: (function (x, y, t) {
            return x * (1 - t) + y * t;
        }).toString(),
        CLAMP: (function (x, lo, hi) {
            var _a;
            _a = [Math.min(lo, hi), Math.max(lo, hi)], lo = _a[0], hi = _a[1];
            return Math.min(Math.max(x, lo), hi);
        }).toString(),
        MAPVAL: (function (x, istart, istop, ostart, ostop) {
            return ostart + (ostop - ostart) * ((x - istart) / (istop - istart));
        }).toString()
    };
    Object.getOwnPropertyNames(Math).map(function (x) { return builtins[x.toUpperCase()] = "Math[\"" + x + "\"]"; });
    return __val.toString() + ";" + __tolist.toString() + ";" + __makelist.toString() + ";" + Object['entries'](builtins).map(function (x) { return "const " + x[0] + "=" + x[1]; }).join(";") + ";let __out='';" + transpilePSVGList(prgm) + ";" + "__out;";
    function transpilePSVGList(prgm) {
        var _a, _b, _c;
        var out = "";
        var groups = 0;
        function transpileValue(x) {
            x = x.trim();
            x = x.replace(/&gt;/g, ">").replace(/&lt;/g, "<").replace(/&amp;/g, "&").replace(/&quot;/g, '"');
            if (x['startsWith']("{") && x['endsWith']("}") && (x.match(/{|}/g) || []).length == 2) {
                return x.slice(1, -1);
            }
            if (new RegExp(/^[+-]?(\d+([.]\d*)?([eE][+-]?\d+)?|[.]\d+([eE][+-]?\d+)?)$/g).test(x)) {
                return x;
            }
            // crappy safari doesn't support lookbehind yet
            // return '__val(`'+x.replace(/(?<!\\)\{/g,"${") + "`)";
            return '__val(`' + x.replace(/([^\\]|^)\{/g, '$1${') + "`)";
        }
        for (var i = 0; i < prgm.length; i++) {
            if (prgm[i].tagName.toUpperCase() == "PSVG") {
                var w = transpileValue((_a = prgm[i].attributes.width) !== null && _a !== void 0 ? _a : "100");
                var h = transpileValue((_b = prgm[i].attributes.height) !== null && _b !== void 0 ? _b : "100");
                out += "__out+=`<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"${" + w + "}\" height=\"${" + h + "}\" ";
                for (var k in prgm[i].attributes) {
                    if (!(["width", "height", "background"]['includes'](k))) {
                        out += k + "=\"${" + transpileValue(prgm[i].attributes[k]) + "}\" ";
                    }
                }
                out += ">`;";
                out += "const WIDTH=" + w + ";const HEIGHT=" + h + ";";
                if (prgm[i].attributes.background) {
                    out += "__out+=`<rect x=\"0\" y=\"0\" width=\"${" + w + "}\" height=\"${" + h + "}\" fill=\"${" + transpileValue(prgm[i].attributes.background) + "}\"/>`;";
                }
                out += transpilePSVGList(prgm[i].children);
                out += "__out+='</svg>';";
            }
            else if (prgm[i].tagName.toUpperCase()['startsWith']("DEF-")) {
                var name_1 = prgm[i].tagName.split("-").slice(1).join("-");
                funcs[name_1] = { name: name_1, args: Object.keys(prgm[i].attributes) };
                out += "function " + name_1 + "(" + Object['entries'](prgm[i].attributes).map(function (x) { return x[0] + "=" + transpileValue(x[1]); }) + "){";
                out += transpilePSVGList(prgm[i].children);
                out += "};";
            }
            else if (prgm[i].tagName.toUpperCase() == "IF") {
                if (Object.keys(prgm[i].attributes).length == 0) {
                    for (var j = 0; j < prgm[i].children.length; j++) {
                        if (j != 0) {
                            out += "else ";
                        }
                        if (prgm[i].children[j].attributes["true"]) {
                            out += "if (" + transpileValue(prgm[i].children[j].attributes["true"]) + ")";
                        }
                        else if (prgm[i].children[j].attributes["false"]) {
                            out += "if (!(" + transpileValue(prgm[i].children[j].attributes["false"]) + "))";
                        }
                        out += "{";
                        out += transpilePSVGList(prgm[i].children[j].children);
                        out += "}";
                    }
                    out += ";";
                }
                else {
                    if (prgm[i].attributes["true"]) {
                        out += "if (" + transpileValue(prgm[i].attributes["true"]) + "){";
                    }
                    else if (prgm[i].attributes["false"]) {
                        out += "if (!(" + transpileValue(prgm[i].attributes["false"]) + ")){";
                    }
                    out += transpilePSVGList(prgm[i].children);
                    out += "};";
                }
            }
            else if (prgm[i].tagName.toUpperCase() == "PUSH") {
                out += transpilePSVGList(prgm[i].children);
            }
            else if (prgm[i].tagName.toUpperCase() == "TRANSLATE") {
                out += "__out+=`<g transform=\"translate(${" + transpileValue(prgm[i].attributes.x) + "} ${" + transpileValue(prgm[i].attributes.y) + "})\">`;";
                groups++;
            }
            else if (prgm[i].tagName.toUpperCase() == "ROTATE") {
                if (prgm[i].attributes.rad) {
                    out += "__out+=`<g transform=\"rotate(${(" + transpileValue(prgm[i].attributes.rad) + ")*180/Math.PI})\">`;";
                }
                else {
                    out += "__out+=`<g transform=\"rotate(${" + transpileValue(prgm[i].attributes.deg) + "})\">`;";
                }
                groups++;
            }
            else if (prgm[i].tagName.toUpperCase() == "STROKE") {
                out += "__out+=`<g ";
                for (var k in prgm[i].attributes) {
                    out += {
                        color: "stroke",
                        value: "stroke",
                        width: "stroke-width",
                        weight: "stroke-width",
                        opacity: "stroke-opacity",
                        cap: "stroke-linecap",
                        join: "stroke-linejoin",
                        dash: "stroke-dasharray",
                        dashoffset: "stroke-dashoffset",
                        miterlimit: "stroke-miterlimit"
                    }[k] + "=\"${" + transpileValue(prgm[i].attributes[k]) + "}\" ";
                }
                out += ">`;";
                groups++;
            }
            else if (prgm[i].tagName.toUpperCase() == "FILL") {
                out += "__out+=`<g ";
                for (var k in prgm[i].attributes) {
                    out += {
                        color: "fill",
                        value: "fill",
                        opacity: "fill-opacity",
                        rule: "fill-rule"
                    }[k] + "=\"${" + transpileValue(prgm[i].attributes[k]) + "}\" ";
                }
                out += ">`;";
                groups++;
            }
            else if (prgm[i].tagName.toUpperCase() == "FONT") {
                out += "__out+=`<g ";
                for (var k in prgm[i].attributes) {
                    out += {
                        family: "font-family",
                        font: "font-family",
                        style: "font-style",
                        variant: "font-variant",
                        stretch: "font-stretch",
                        size: "font-size",
                        anchor: "text-anchor",
                        weight: "font-weight",
                        decoration: "text-decoration"
                    }[k] + "=\"${" + transpileValue(prgm[i].attributes[k]) + "}\" ";
                }
                out += ">`;";
                groups++;
            }
            else if (prgm[i].tagName.toUpperCase() == "SCALE") {
                out += "__out+=`<g transform=\"scale(${" + transpileValue(prgm[i].attributes.x) + "} ${" + transpileValue(prgm[i].attributes.y) + "})\">`;";
                groups++;
            }
            else if (prgm[i].tagName.toUpperCase() == "VAR") {
                for (var k in prgm[i].attributes) {
                    out += "let " + k + "=" + transpileValue(prgm[i].attributes[k]) + ";";
                }
            }
            else if (prgm[i].tagName.toUpperCase() == "ASGN" || prgm[i].tagName.toUpperCase() == "ASSIGN") {
                for (var k in prgm[i].attributes) {
                    out += k + "=" + transpileValue(prgm[i].attributes[k]) + ";";
                }
            }
            else if (prgm[i].tagName.toUpperCase() == "RETURN") {
                for (var j = 0; j < groups; j++) {
                    out += "__out+='</g>';";
                }
                if (prgm[i].attributes.value) {
                    out += "return " + transpileValue(prgm[i].attributes.value) + ";";
                }
                else {
                    out += "return;";
                }
            }
            else if (prgm[i].tagName.toUpperCase() == "FOR") {
                var name_2 = void 0;
                for (var k in prgm[i].attributes) {
                    if (!(["true", "false", "step"]['includes'](k))) {
                        name_2 = k;
                        break;
                    }
                }
                var step = (_c = prgm[i].attributes['step']) !== null && _c !== void 0 ? _c : "1";
                out += "for (let " + name_2 + "=" + transpileValue(prgm[i].attributes[name_2]) + ";";
                if (prgm[i].attributes["true"]) {
                    out += transpileValue(prgm[i].attributes["true"]) + ";";
                }
                else {
                    out += "!(" + transpileValue(prgm[i].attributes["false"]) + ");";
                }
                out += name_2 + "+=" + transpileValue(step) + "){";
                out += transpilePSVGList(prgm[i].children);
                out += "};";
            }
            else if (prgm[i].tagName.toUpperCase() == "WHILE") {
                if (prgm[i].attributes["true"]) {
                    out += "while (" + transpileValue(prgm[i].attributes["true"]) + "){";
                }
                else {
                    out += "while (!(" + transpileValue(prgm[i].attributes["false"]) + ")){";
                }
                out += transpilePSVGList(prgm[i].children);
                out += "};";
            }
            else if (prgm[i].tagName in funcs) {
                out += prgm[i].tagName + "(";
                var args = funcs[prgm[i].tagName].args;
                for (var j = 0; j < args.length; j++) {
                    var v = prgm[i].attributes[args[j]];
                    out += v === undefined ? "undefined" : transpileValue(v);
                    out += ",";
                }
                out += ");";
            }
            else {
                out += "__out+=`<" + prgm[i].tagName + " ";
                for (var k in prgm[i].attributes) {
                    out += k + "=\"${" + transpileValue(prgm[i].attributes[k]) + "}\" ";
                }
                var needInner = ["TEXT", "STYLE"]['includes'](prgm[i].tagName.toUpperCase());
                if (prgm[i].children.length || needInner) {
                    out += ">`;";
                    out += transpilePSVGList(prgm[i].children);
                    if (needInner) {
                        out += "__out+=`" + prgm[i].innerHTML.replace(/`/g, "/`").replace(/<.*?>/g, "") + "`;";
                    }
                    out += "__out+='</" + prgm[i].tagName + ">';";
                }
                else {
                    out += "/>`;";
                }
            }
        }
        for (var i = 0; i < groups; i++) {
            out += "__out+='</g>';";
        }
        return out;
    }
}
function evalPSVG(js) {
    return Function("\"use strict\";" + js + ";return __out;")();
}
function compilePSVG(psvg) {
    var prgm = parsePSVG(psvg);
    // console.dir(prgm,{depth:null});
    var js = transpilePSVG(prgm);
    // console.log(js);
    return evalPSVG(js);
}
/*@ts-ignore*/
/*@ts-ignore*/ if (typeof module != 'undefined') {
    /*@ts-ignore*/ if (!module.parent) {
        /*@ts-ignore*/ var fs = require('fs');
        /*@ts-ignore*/ if (!process.argv[2]) {
            console.log("usage: psvg input.psvg > output.svg");
            process.exit();
        }
        /*@ts-ignore*/ console.log(compilePSVG(fs.readFileSync(process.argv[2]).toString()));
        /*@ts-ignore*/ }
    else {
        /*@ts-ignore*/ module.exports = { parsePSVG: parsePSVG, transpilePSVG: transpilePSVG, evalPSVG: evalPSVG, compilePSVG: compilePSVG };
        /*@ts-ignore*/ }
    /*@ts-ignore*/ }
else {
    /*@ts-ignore*/ window.addEventListener('load', function () {
        /*@ts-ignore*/ var psvgs = document.getElementsByTagName("PSVG");
        /*@ts-ignore*/ for (var i = 0; i < psvgs.length; i++) {
            /*@ts-ignore*/ psvgs[i].outerHTML = compilePSVG(psvgs[i].outerHTML);
            /*@ts-ignore*/ }
        /*@ts-ignore*/ 
    });
    /*@ts-ignore*/ }
/*@ts-ignore*/

</script>
<script>
  var themeName = "xq-light";
  var examples = {"helloworld.psvg":"<!-- helloworld.psvg           -->\n<!-- draws text \"Hello World!\" -->\n\n<psvg width=\"512\" height=\"512\">\n  \n  <font family=\"sans-serif\" \n        weight=\"bold\"\n        anchor=\"middle\"\n  />\n  <stroke color=\"black\"/>\n  \n  \n  <for i=\"-40\" true=\"{i<=WIDTH/2}\" step=\"4\">\n    <text x=\"{WIDTH-i}\" y=\"{i+40-SIN(i*0.1)*10}\"\n          fill=\"rgb(255,{i},{255-i})\"\n          font-size=\"46\">\n      Hello World!\n    </text>\n  </for>\n  \n  <for i=\"0\" true=\"{i<=WIDTH/2}\" step=\"4\">\n    <text x=\"{i-SIN(i*0.1)*10}\" y=\"{i}\"\n          fill=\"white\"\n          font-size=\"100\">\n      PSVG\n    </text>\n    \n  </for>\n\n</psvg>","hilbert.psvg":"<!-- hilbert.psvg            -->\n<!-- draws a hiblert curve   -->\n<!-- based on https://en.wikipedia.org/wiki/Hilbert_curve\n          and http://www.rosettacode.org/wiki/Hilbert_curve#Java -->\n<psvg width=\"256\" height=\"256\">\n\n  <def-rot n=\"\" x=\"\" y=\"\" rx=\"\" ry=\"\">\n    <if true=\"{ry==0}\">\n      <if true=\"{rx==1}\">\n        <asgn x=\"{(n-1)-x}\"/>\n        <asgn y=\"{(n-1)-y}\"/>\n      </if>\n      <var t=\"{x}\"/>\n      <asgn x=\"{y}\"/>\n      <asgn y=\"{t}\"/>\n    </if>\n    <return value=\"{x},{y}\"/>\n  </def-rot>\n\n  <def-d2xy n=\"\" d=\"\">\n    <var rx=\"0\" ry=\"0\" t=\"{d}\" x=\"0\" y=\"0\"/>\n    <for s=\"1\" true=\"{s<n}\" step=\"{s}\">\n      <asgn rx=\"{(t/2) &amp;1}\"/>\n      <asgn ry=\"{(t^rx)&amp;1}\"/>\n      <var xy=\"{rot(s,x,y,rx,ry)}\"/>\n      <asgn x=\"{NTH(xy,0)}\"/>\n      <asgn y=\"{NTH(xy,1)}\"/>\n      <asgn x=\"{x+s*rx}\"/>\n      <asgn y=\"{y+s*ry}\"/>\n      <asgn t=\"{t/4}\"/>\n    </for>\n    <return value=\"{x},{y}\"/>\n  </def-d2xy>\n\n  <def-hilbert n=\"\">\n    <var pts=\"\"/>\n    <for d=\"0\" true=\"{d<n*n}\" step=\"1\">\n      <var xy=\"{d2xy(n,d)}\"/>\n      <asgn pts=\"{CAT(pts,xy)}\"/>\n    </for>\n    <return value=\"{pts}\"/>\n  </def-hilbert>\n\n  <var order=\"5\"/>\n  <var n=\"{1 &lt;&lt; order}\"/>\n  <scale x=\"{WIDTH/n}\" y=\"{HEIGHT/n}\"/>\n\n  <stroke color=\"black\"/>\n  <fill color=\"none\"/>\n  <polyline points=\"{hilbert(n)}\" vector-effect=\"non-scaling-stroke\"/>\n\n</psvg>","koch.psvg":"<!-- koch.psvg               -->\n<!-- draws a koch snowflake  -->\n<psvg width=\"400\" height=\"400\">\n  <def-snowflake x1=\"\" y1=\"\" x2=\"\" y2=\"\" d=\"\">\n    <if true=\"{d==0}\">\n      <line x1=\"{x1}\" y1=\"{y1}\" x2=\"{x2}\" y2=\"{y2}\" />\n      <return/>\n    </if>\n    <var x3=\"{(x1*2+x2)/3}\"/>\n    <var x4=\"{(x2*2+x1)/3}\"/>\n    <var y3=\"{(y1*2+y2)/3}\"/>\n    <var y4=\"{(y2*2+y1)/3}\"/>\n    <var dx=\"{(x2-x1)/3}\"/>\n    <var dy=\"{(y2-y1)/3}\"/>\n    <var x5=\"{(dx-dy*SQRT(3))/2+x3}\"/>\n    <var y5=\"{(dy+dx*SQRT(3))/2+y3}\"/>\n    <snowflake x1=\"{x1}\" y1=\"{y1}\" x2=\"{x3}\" y2=\"{y3}\" d=\"{d-1}\"/>\n    <snowflake x1=\"{x3}\" y1=\"{y3}\" x2=\"{x5}\" y2=\"{y5}\" d=\"{d-1}\"/>\n    <snowflake x1=\"{x5}\" y1=\"{y5}\" x2=\"{x4}\" y2=\"{y4}\" d=\"{d-1}\"/>\n    <snowflake x1=\"{x4}\" y1=\"{y4}\" x2=\"{x2}\" y2=\"{y2}\" d=\"{d-1}\"/>\n  </def-snowflake>\n\n  <stroke color=\"black\" cap=\"round\"/>\n  <snowflake x1=\"200\" y1=\"10\"  x2=\"50\"  y2=\"310\" d=\"5\"/>\n  <snowflake x1=\"350\" y1=\"310\" x2=\"200\" y2=\"10\"  d=\"5\"/>\n  <snowflake x1=\"50\"  y1=\"310\" x2=\"350\" y2=\"310\" d=\"5\"/>\n\n</psvg>","poisson.psvg":"<!-- poisson.psvg           -->\n<!-- poisson disk sampling  -->\n<!-- based on paper https://www.cs.ubc.ca/~rbridson/docs/bridson-siggraph07-poissondisk.pdf -->\n<!-- and this impl. https://editor.p5js.org/codingtrain/sketches/4N78DFCXN                  -->\n<psvg width=\"300\" height=\"300\" background=\"black\">\n\n  <def-dist2 x0=\"\" y0=\"\" x1=\"\" y1=\"\">\n    <var dx=\"{x0-x1}\"/>\n    <var dy=\"{y0-y1}\"/>\n    <return value=\"{dx*dx+dy*dy}\"/>\n  </def-dist2>\n\n  <def-poissondisk r=\"4\" k=\"30\">\n    <var active=\"\"/>\n    \n    <var w=\"{r/SQRT(2)}\"/>\n    <var r2=\"{r*r}\"/>\n    <var cols=\"{FLOOR(WIDTH/w)}\"/>\n    <var rows=\"{FLOOR(HEIGHT/w)}\"/>\n    \n    <var grid=\"{FILL(-1,cols*rows)}\"/>\n    <var samples=\"{WIDTH/2} {HEIGHT/2}\"/>\n\n    <for i=\"0\" true=\"{i<COUNT(samples)}\" step=\"2\">\n      <asgn active=\"{CAT(active,NTH(samples,i),NTH(samples,i+1))}\"/>\n      <var col=\"{FLOOR(NTH(samples,i)/w)}\"/>\n      <var row=\"{FLOOR(NTH(samples,i+1)/w)}\"/>\n      <asgn grid=\"{UPDATE(grid,row*cols+col,i/2)}\"/>\n    </for>\n\n    <while true=\"{COUNT(active)}\">\n      <var ridx=\"{FLOOR(RANDOM()*COUNT(active)/2)}\"/>\n      <var pos=\"{TAKE(DROP(active,ridx*2),2)}\"/>\n      <var found=\"0\"/>\n      <for n=\"0\" true=\"{n<k}\" step=\"1\">\n        <var sr=\"{RANDOM()*r+r}\"/>\n        <var sa=\"{RANDOM()*PI*2}\"/>\n        <var sx=\"{NTH(pos,0)+sr*COS(sa)}\"/>\n        <var sy=\"{NTH(pos,1)+sr*SIN(sa)}\"/>\n        <var col=\"{FLOOR(sx/w)}\"/>\n        <var row=\"{FLOOR(sy/w)}\"/>\n        <if true=\"{col>0 &amp;&amp; row>0 &amp;&amp;\n                   col<cols-1 &amp;&amp; row<rows-1}\">\n          <var ok=\"1\"/>\n          <for i=\"-1\" true=\"{i<=1}\" step=\"1\">\n            <for j=\"-1\" true=\"{j<=1}\" step=\"1\">\n              <var idx=\"{(row+i)*cols+col+j}\"/>\n              <var nbr=\"{NTH(grid,idx)}\"/>\n              <if true=\"nbr!=-1\">\n                <var d=\"{dist2(sx,sy,NTH(samples,nbr*2),NTH(samples,nbr*2+1))}\"/>\n                <if true=\"{d<r2}\">\n                  <asgn ok=\"0\"/>\n                </if>\n              </if>\n            </for>\n          </for>\n          <if true=\"{ok}\">\n            <asgn found=\"1\"/>\n            <asgn grid=\"{UPDATE(grid,row*cols+col,COUNT(samples)/2)}\"/>\n            <var sample=\"{sx} {sy}\"/>\n            <asgn active=\"{CAT(active,sample)}\"/>\n            <asgn samples=\"{CAT(samples,sample)}\"/>\n          </if>\n        </if>\n\n      </for>\n      <if false=\"{found}\">\n        <asgn active=\"{CAT(TAKE(active,ridx*2),DROP(active,ridx*2+2))}\"/>\n      </if>\n    </while>\n    \n    <for i=\"0\" true=\"{i<COUNT(samples)}\" step=\"2\">\n      <fill color=\"hsl({i/5},80%,80%)\"/>\n      <circle cx=\"{NTH(samples,i)}\" cy=\"{NTH(samples,i+1)}\" r=\"1.2\"/>\n    </for>\n  </def-poissondisk>\n\n  <poissondisk/>\n\n</psvg>","pythagoras.psvg":"<!-- pythagoras.psvg                 -->\n<!-- draws a pythagoras fractal tree -->\n<!-- inspired by https://en.wikipedia.org/wiki/Pythagoras_tree_(fractal)#/media/File:Pythagoras_Tree_Colored.png -->\n<psvg width=\"640\" height=\"480\">\n  <var depth=\"12\"/>\n\n  <defs>\n    <for i=\"0\" true=\"{i<depth}\" step=\"1\">\n      <var t=\"{i/(depth-1)}\"/>\n      <var dark=\"rgb({FLOOR(LERP(110,0,t))},{FLOOR(LERP(50,120,t))},{FLOOR(LERP(0,200,t))})\"/>\n      <linearGradient id=\"grad{i}\">\n        <stop offset=\"0%\"   stop-color=\"{dark}\"/>\n        <stop offset=\"50%\"  stop-color=\"rgb(200,{FLOOR(LERP(100,255,t))},0)\"/>\n        <stop offset=\"100%\" stop-color=\"{dark}\"/>\n      </linearGradient>\n    </for>\n  </defs>\n\n  <def-pythtree w=\"\" d=\"{depth}\">\n    <push>\n      <fill color=\"url(#grad{depth-d})\"/>\n      <path d=\"M0 {w/2} L{w/2} 0 L{w/2} {-w} L{-w/2} {-w} L{-w/2} 0 z\"/>\n    </push>\n\n    <if true=\"{d==0}\">\n      <return/>\n    </if>\n    <push>\n      <translate x=\"{-w/4}\" y=\"{-w-w/4}\"/>\n      <rotate deg=\"-45\"/>\n      <pythtree w=\"{w/SQRT(2)}\" d=\"{d-1}\"/>\n    </push>\n    <push>\n      <translate x=\"{w/4}\" y=\"{-w-w/4}\"/>\n      <rotate deg=\"45\"/>\n      <pythtree w=\"{w/SQRT(2)}\" d=\"{d-1}\"/>\n    </push>\n  </def-pythtree>\n\n  <translate x=\"{WIDTH/2}\" y=\"{HEIGHT}\"/>\n  <pythtree w=\"100\"/>\n</psvg>","sierpinski.psvg":"<!-- sierpinski.psvg               -->\n<!-- draws a Sierpinski's triangle -->\n<psvg width=\"300\" height=\"260\">\n\n  <def-sierptri x1=\"\" y1=\"\" x2=\"\" y2=\"\" x3=\"\" y3=\"\" d=\"7\">\n    <path d=\"M{x1} {y1} L{x2} {y2} L{x3} {y3} z\"/>\n    <if true=\"{d==0}\">\n      <return/>\n    </if>\n    <sierptri x1=\"{x1}\" y1=\"{y1}\" x2=\"{(x1+x2)/2}\" y2=\"{(y1+y2)/2}\" x3=\"{(x3+x1)/2}\" y3=\"{(y3+y1)/2}\" d=\"{d-1}\"/>\n    <sierptri x1=\"{x2}\" y1=\"{y2}\" x2=\"{(x2+x3)/2}\" y2=\"{(y2+y3)/2}\" x3=\"{(x1+x2)/2}\" y3=\"{(y1+y2)/2}\" d=\"{d-1}\"/>\n    <sierptri x1=\"{x3}\" y1=\"{y3}\" x2=\"{(x3+x1)/2}\" y2=\"{(y3+y1)/2}\" x3=\"{(x2+x3)/2}\" y3=\"{(y2+y3)/2}\" d=\"{d-1}\"/>\n  </def-sierptri>\n\n  <fill opacity=\"0.1\"/>\n  <sierptri x1=\"{WIDTH/2}\" y1=\"0\" x2=\"{WIDTH}\" y2=\"{HEIGHT}\" x3=\"0\" y3=\"{HEIGHT}\"/>\n\n</psvg>","textanim.psvg":"<!-- text-anim.psvg      -->\n<!-- draws animated text -->\n\n<psvg width=\"600\" height=\"230\">\n  \n  <font family=\"sans-serif\" \n        weight=\"bold\"\n        anchor=\"middle\"\n  />\n  <stroke color=\"black\"/>\n  \n  \n  <for i=\"-60\" true=\"{i<WIDTH/2}\" step=\"4\">\n    <text x=\"{WIDTH-i}\" y=\"{i/2+60-SIN(i*0.1)*10}\"\n          fill=\"rgb(255,{i},{255-i})\"\n          font-size=\"46\">\n      <animate attributeName=\"x\" \n               values=\"{WIDTH-i+10};{WIDTH-i-10};{WIDTH-i+10}\" \n               begin=\"{i/100}s\" \n               dur=\"1s\" \n               repeatCount=\"indefinite\" />\n      <animate attributeName=\"fill\" \n               values=\"rgb(255,{i},{255-i});rgb(255,{255-i},{i});rgb(255,{i},{255-i})\" \n               begin=\"{i/100}s\" \n               dur=\"1s\" \n               repeatCount=\"indefinite\" />\n      Draws itself!\n    </text>\n  </for>\n  \n  <for i=\"0\" true=\"{i<WIDTH/2}\" step=\"4\">\n    <text x=\"{i-SIN(i*0.1)*10}\" y=\"{i/2+30}\"\n          fill=\"white\"\n          font-size=\"100\">\n      <animate attributeName=\"y\" \n               values=\"{i/2+30};{i/2-20};{i/2+30}\" \n               begin=\"{i/100}s\" \n               dur=\"1s\" \n               repeatCount=\"indefinite\" />\n      PSVG\n    </text>\n  </for>\n  \n</psvg>","tree.psvg":"<!-- tree.psvg                                           -->\n<!-- A port of https://processing.org/examples/tree.html -->\n<psvg width=\"640\" height=\"360\">\n\n  <def-branch h=\"0\">\n    <asgn h=\"{h*0.66}\"/>\n    <if true=\"{h>2}\">\n      <push>\n        <rotate rad=\"{theta}\"/>\n        <line x1=\"0\" y1=\"0\" x2=\"0\" y2=\"{-h}\"/>\n        <translate x=\"0\" y=\"{-h}\"/>\n        <branch h=\"{h}\"/>\n      </push>\n      <push>\n        <rotate rad=\"{-theta}\"/>\n        <line x1=\"0\" y1=\"0\" x2=\"0\" y2=\"{-h}\"/>\n        <translate x=\"0\" y=\"{-h}\"/>\n        <branch h=\"{h}\"/>\n      </push>\n    </if>\n  </def-branch>\n\n  <var theta=\"{PI/6}\"/>\n\n  <translate x=\"{WIDTH/2}\" y=\"{HEIGHT}\"/>\n\n  <stroke color=\"black\" cap=\"round\"/>\n  <line x1=\"0\" y1=\"0\" x2=\"0\" y2=\"-120\"/>\n  <translate x=\"0\" y=\"-120\"/>\n  <branch h=\"120\"/>\n\n</psvg>"}
  function main(){
  var CM = CodeMirror(document.getElementById("c"), {
    lineNumbers:true,
    matchBrackets: true,
    theme:themeName,
    mode:  "xml",
    extraKeys:{
      'Ctrl-/': 'toggleComment',
      'Cmd-/': 'toggleComment'
    }
  });

  CM.setValue(examples["koch.psvg"]);
  document.getElementById('o').innerHTML = compilePSVG(examples["koch.psvg"]);
  document.getElementById('s').value = "koch.psvg";
  document.getElementById('s').onchange = function(){
    CM.setValue(examples[document.getElementById('s').value]);
    document.getElementById('r').onclick();
  }

  document.getElementById('r').onclick = function(){
    document.getElementById('o').innerHTML = compilePSVG(CM.getValue());
  }
}
  main();
</script>
